<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>طلب تحويل بين الفروع</title>
  <style>
    :root{ --bg:#ffffff; --panel:#ffffff; --text:#0b0f14; --muted:#4b5563; --line:#e5e7eb; --btn:#111111; --btnText:#ffffff; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{padding:18px 20px;border-bottom:1px solid var(--line);background:var(--panel);position:sticky;top:0;z-index:10}
    .head{display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;gap:10px;align-items:center}
    .brand img{width:34px;height:34px;border-radius:50%}
    h1{margin:0;font-size:18px;font-weight:800}
    label{font-size:13px;color:#374151;margin-inline-start:6px}
    .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;align-items:end;margin-top:12px}
    select,input{background:#ffffff;border:1px solid #cfd4dc;color:var(--text);padding:10px 12px;border-radius:10px;outline:none;width:100%}
    .search{grid-column: span 3}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}
    main{display:grid;grid-template-columns:1fr 360px}
    @media(max-width:1050px){main{grid-template-columns:1fr} aside{position:static;height:auto} .row{grid-template-columns:1fr} .search{grid-column:span 1} }
    .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;padding:16px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden;transition:transform .08s}
    .card:hover{transform:translateY(-2px)}
    .card img{width:100%;height:170px;object-fit:cover;background:#f3f4f6;display:block}
    .meta{padding:10px 12px}
    .name{font-size:14px;font-weight:700;margin-bottom:4px}
    .sku{font-size:12px;color:#6b7280}
    .bar{display:flex;gap:6px;justify-content:space-between;align-items:center;padding:10px 12px;border-top:1px solid var(--line)}
    .qty{display:flex;gap:6px;align-items:center}
    .qty button{background:#f3f4f6;border:1px solid #d1d5db;color:#111;padding:6px 10px;border-radius:10px;cursor:pointer}
    .qty input{width:58px;text-align:center}
    .add{background:var(--btn);border:none;color:var(--btnText);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
    aside{border-right:1px solid var(--line);background:var(--panel);padding:14px;height:calc(100vh - 160px);position:sticky;top:160px;display:flex;flex-direction:column;gap:12px}
    aside h2{margin:0 0 6px 0;font-size:16px}
    .list{flex:1;overflow:auto;border:1px dashed #d1d5db;border-radius:12px;padding:8px}
    .rowitem{display:grid;grid-template-columns:44px 1fr auto;gap:10px;align-items:center;border-bottom:1px solid #eee;padding:8px 0}
    .rowitem:last-child{border-bottom:none}
    .thumb{width:44px;height:44px;border-radius:8px;object-fit:cover;background:#f3f4f6;border:1px solid #e5e7eb}
    .btn{background:var(--btn);border:none;color:var(--btnText);padding:12px;border-radius:12px;cursor:pointer;font-weight:700}
    .btn.full{width:100%}
    .note{color:#6b7280;font-size:12px}
    .divider{height:1px;background:#eee;margin:8px 0}
    .admin{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .admin button{padding:10px 12px;border-radius:10px;border:1px solid #111;background:#fff;color:#111;cursor:pointer}
    .admin small{color:#6b7280}

    /* Manager overlay */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50}
    .panel{background:#fff;width:min(1200px,94vw);height:min(90vh,800px);border-radius:16px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .panel-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eee}
    .panel-title{font-weight:800}
    .close{background:#111;color:#fff;border:none;border-radius:10px;padding:8px 12px;cursor:pointer}
    .panel-body{padding:14px;overflow:auto}
    .mgr-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
    .mgr-card{position:relative;border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;background:#fff}
    .mgr-card img{width:100%;height:150px;object-fit:cover;background:#f3f4f6;display:block}
    .mgr-meta{padding:10px 12px}
    .mgr-name{font-size:13px;font-weight:700;margin-bottom:4px}
    .mgr-sku{font-size:12px;color:#6b7280}

    .delete-x{position:absolute;top:8px;left:8px;width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#ef4444;color:#fff;font-weight:900;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.2)}
    .wiggle{animation:wiggle .3s ease-in-out infinite alternate}
    @keyframes wiggle{ from{ transform:rotate(-1.5deg) scale(1.01);} to{ transform:rotate(1.5deg) scale(1.01);} }
  </style>
</head>
<body>
  <header>
    <div class="head">
      <div class="brand">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADgAAAA5CAYAAABj2ui7AAAACXBIWXMAAAsSAAALEgHS3X78AAADWElEQVRogd1b3ZHaMBDeeO6d6wB3ELuCOM9+ODoIpwouFYR0QAUOV8HBg5+PVGCuA6ggoQIyctY6IzCWVitbc98MMzecJevT/mpXfDqdTjAE0ry4B4AEAPZVKfaDvBQA2AmmeZEBQIZkYgD4fOPxgyQMAFv5qUqxZV0MF0EkNQeAGQBMHKY6AsBafqpSrJ0X5kowzQtJagEAU47FaJDSXVSlWLlMQiKY5oWU1NITMR2S6BNVolYE0VHIHX0gLtYFv6UZ2DooY4JoZ2tHG3PFEUkaSzMyeQht7XVkcoDvf0nz4sl0QK8E07xI0N584gth7ueqFHNngkOB6JF7SQZDEN6d2M6S5PeqFJ0aFhRBeHdmr5bDvnZlQcERhP8k95ZSlN41rkrxV/+HkRcdAbbJ+ATj8wXu2l+gx5wx8FkNeWJAPMgMS4+Rd9pDS6LL1vEjzYtHhzwyIY5bYjKioFQUjZuDXAOSJqAWUROKKYYbhbYNLoiTduGeOK43ePfgjEdNEHeNU3qgq4oFMsf3TlEbazQSdN21a7A+nad50VcBMIXi0xDk8JxtHKtS7AjjuNah5olQPbkPrtTaiqt6Npg0ahoxTtqGtf1hHsp5kFYEqTHnFigS5N5oRTBmnvhAzGK4/UDNKwooPHATrP2Kj2SbEh4yH+UQaddBEPQgvQYJN8G3a2cyA/giyK6ilPAQ+ywgcxMMST1rsBIkdod8EtxxEtzYDsDshTtMKUh/EGHNnwOhSU82bWoV5aqdhJCetVGfZqLmD0eMfTy6BkWQo21MCQ9espcW6jVFuPMHx8lCsz+lUY0Xde2Hh0ZQ8WkIurTHrI9HvrOXdpW7JogLpIYLivS9hod2wsFRF6VUr30SPONx1l1K82JrmVn8rEphtTGYvfyxGWMBKb2zCoXem1gYSlJ6qCWxNGHcXyfgor47aH8Qpbf3FP82VSkuVH/o/uDKE7ljV3V+MILY9fF1gWjWVUnQbZAdqJYyzn7z9IrHW+dQbwQxmM/RqfjKOZ/7mqy9BIkXgVyamKbguwiE9vPL84JtYNwet7mMl2BSPfZlvJlN7cfYi+LxI6bUXpiwwbswVicX6oXYDGPax7oQq+PDXmnW4eFS+orrBv7YPyt4w9xU2jf/zwoA4B+Ar02yhlrPfQAAAABJRU5ErkJggg==" alt="logo">
        <h1>من فرع → إلى فرع</h1>
      </div>
      <div class="admin">
        <button id="adminUpload">تحديث المنتجات</button>
        <button id="viewProducts">📦 استعراض المنتجات</button>
        <small>خاص بالمسؤول</small>
        <input type="file" id="csvAdmin" accept=".csv">
      </div>
    </div>
    <div class="row">
      <div>
        <label for="fromBranch">من فرع</label>
        <select id="fromBranch" required><option value="" disabled selected>اختر الفرع (من)</option><option>مستودعات الغناميه</option><option>مستودعات الخرج</option><option>دراجتي النرجس</option></select>
      </div>
      <div>
        <label for="toBranch">إلى فرع</label>
        <select id="toBranch" required><option value="" disabled selected>اختر الفرع (إلى)</option><option>مستودعات الغناميه</option><option>مستودعات الخرج</option><option>دراجتي النرجس</option><option>دراجتي الخبر</option><option>دراجتي جدة</option><option>دراجتي الصحافه</option><option>دراجتي السليمانيه</option><option>دراجتي المسار الرياضي</option><option>هجين الملز</option><option>هجين الروابي</option><option>هجين المدينة المنوره</option><option>هجين حائل</option></select>
      </div>
      <div>
        <label for="search">بحث</label>
        <input class="search" type="text" id="search" placeholder="بحث بالاسم أو SKU">
      </div>
    </div>
    <div class="hint">سيُنزّل ملف CSV باسم يتضمن (من/إلى). المحتوى: <b>SKU, Quantity</b>. كما سيتم إرساله إلى Zapier تلقائيًا.</div>
  </header>

  <main>
    <section id="gallery" class="gallery"></section>
    <aside>
      <h2>السلة</h2>
      <div id="cart" class="list"></div>
      <div class="divider"></div>
      <button class="btn full" id="submitOrder">إرسال الطلب</button>
      <div class="note">الاختيار إلزامي للفرعين.</div>
    </aside>
  </main>

  <!-- Manager Overlay -->
  <div class="overlay" id="manager">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">إدارة المنتجات</div>
        <div style="display:flex;align-items:center;gap:8px">
          <button class="close" id="toggleWiggle">وضع الحذف</button>
          <button class="close" id="closeManager">إغلاق ✕</button>
        </div>
      </div>
      <div class="panel-body">
        <div class="mgr-grid" id="mgrGrid"></div>
      </div>
    </div>
  </div>

  <script>
    const webhookURL = "https://hooks.zapier.com/hooks/catch/20490421/utyod6s/";
    const ADMIN_CODE = "0155"; // كلمة السر لتحديث/استعراض المنتجات
    let adminUnlocked = false;
    let deleteMode = false;

    // منتجات عينة (تتبدل عند رفع CSV)
    let PRODUCTS = [
      {sku:"SCOOT-F70", name:"سكوتر كهربائي F70", image:"https://images.unsplash.com/photo-1516503412436-6e4f2e90b53c?q=80&w=900&auto=format&fit=crop"},
      {sku:"SCOOT-CITY", name:"سكوتر حضري City", image:"https://images.unsplash.com/photo-1541625602330-2277a4c46182?q=80&w=900&auto=format&fit=crop"},
      {sku:"BIKE-HYB-V8", name:"دراجة هجينة V8", image:"https://images.unsplash.com/photo-1452626038306-9aae5e071dd3?q=80&w=900&auto=format&fit=crop"},
      {sku:"BIKE-MTB-29", name:"دراجة جبلية 29", image:"https://images.unsplash.com/photo-1511739001486-6bfe10ce785f?q=80&w=900&auto=format&fit=crop"},
      {sku:"HELMET-SAFE", name:"خوذة سلامة", image:"https://images.unsplash.com/photo-1610680022647-6ef737cae56f?q=80&w=900&auto=format&fit=crop"}
    ];

    let CART = {}; // sku -> {sku, name, image, qty}

    const gallery = document.getElementById('gallery');
    const cartEl  = document.getElementById('cart');
    const searchEl= document.getElementById('search');
    const fromEl  = document.getElementById('fromBranch');
    const toEl    = document.getElementById('toBranch');
    const adminBtn= document.getElementById('adminUpload');
    const adminFile= document.getElementById('csvAdmin');
    const viewBtn = document.getElementById('viewProducts');

    const mgr = document.getElementById('manager');
    const mgrGrid = document.getElementById('mgrGrid');
    const closeManager = document.getElementById('closeManager');
    const toggleWiggle = document.getElementById('toggleWiggle');

    // Admin file input invisible but clickable programmatically
    adminFile.style.width="0.1px"; adminFile.style.height="0.1px"; adminFile.style.opacity="0"; adminFile.style.position="absolute"; adminFile.style.zIndex="-1";

    function requireAdmin(cb){
      if(!adminUnlocked){
        const code = prompt('أدخل كلمة السر:');
        if(code === ADMIN_CODE){
          adminUnlocked = true;
          setTimeout(()=>adminUnlocked=false, 5*60*1000);
        } else { alert('كلمة السر غير صحيحة.'); return; }
      }
      cb && cb();
    }

    // Update Products (CSV upload)
    adminBtn.addEventListener('click', ()=> requireAdmin(()=> adminFile.click()));

    adminFile.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      const text = await f.text();
      const list = parseShopifyCSV(text);
      if(!list.length) { alert('لم يتم العثور على بيانات صالحة. تأكد من الأعمدة: Title, Variant SKU, Image Src'); return; }
      PRODUCTS = list;
      CART = {};
      renderCart(); renderGallery();
      alert('تم تحديث المنتجات بنجاح.');
      adminFile.value="";
    });

    // View/Manage Products
    viewBtn.addEventListener('click', ()=> requireAdmin(showManager));
    closeManager.addEventListener('click', ()=> mgr.style.display='none');
    toggleWiggle.addEventListener('click', ()=>{ deleteMode = !deleteMode; renderManager(); });

    function showManager(){
      mgr.style.display='flex';
      renderManager();
    }

    function renderManager(){
      mgrGrid.innerHTML='';
      PRODUCTS.forEach((p,idx)=>{
        const card = document.createElement('div'); card.className='mgr-card' + (deleteMode ? ' wiggle' : '');
        const img  = document.createElement('img'); img.src=p.image||''; img.alt=p.name||p.sku||'منتج'; card.appendChild(img);
        const meta = document.createElement('div'); meta.className='mgr-meta';
        const name = document.createElement('div'); name.className='mgr-name'; name.textContent = p.name || p.sku;
        const sku  = document.createElement('div'); sku.className='mgr-sku'; sku.textContent = 'باركود: ' + (p.sku||'');
        meta.appendChild(name); meta.appendChild(sku);
        card.appendChild(meta);

        const del = document.createElement('div'); del.className='delete-x'; del.textContent='×';
        del.title='حذف المنتج';
        del.onclick = ()=>{
          if(!deleteMode) return;
          if(confirm('هل تريد حذف هذا المنتج؟')) {
            PRODUCTS.splice(idx,1);
            renderManager(); renderGallery();
          }
        };
        card.appendChild(del);

        mgrGrid.appendChild(card);
      });
    }

    searchEl.addEventListener('input', renderGallery);

    function renderGallery(){
      const term = (searchEl.value||'').toLowerCase();
      gallery.innerHTML='';
      const list = PRODUCTS.filter(p=>!term || (p.name||'').toLowerCase().includes(term) || (p.sku||'').toLowerCase().includes(term));
      if(!list.length){ const d=document.createElement('div'); d.style.color='#6b7280'; d.textContent='لا توجد منتجات.'; gallery.appendChild(d); return; }
      list.forEach(p=>{
        const card = document.createElement('div'); card.className='card';
        const img  = document.createElement('img'); img.src=p.image||''; img.alt=p.name||p.sku||'منتج'; card.appendChild(img);
        const meta = document.createElement('div'); meta.className='meta';
        const name = document.createElement('div'); name.className='name'; name.textContent = p.name || p.sku;
        const sku  = document.createElement('div'); sku.className='sku'; sku.textContent = 'باركود: ' + (p.sku||'');
        meta.append(name, sku);
        const bar  = document.createElement('div'); bar.className='bar';
        const qty  = document.createElement('div'); qty.className='qty';
        const minus= document.createElement('button'); minus.textContent='-'; minus.onclick=()=>add(p,-1);
        const input= document.createElement('input'); input.type='number'; input.min='0'; input.value=getQty(p.sku); input.onchange=(e)=>setQty(p.sku, parseInt(e.target.value||'0',10));
        const plus = document.createElement('button'); plus.textContent='+'; plus.onclick=()=>add(p,1);
        qty.append(minus,input,plus);
        const addB = document.createElement('button'); addB.className='add'; addB.textContent='إضافة'; addB.onclick=()=>add(p, Math.max(1, parseInt(input.value||'1',10)));
        bar.append(qty, addB);
        card.appendChild(meta);
        card.appendChild(bar);
        gallery.appendChild(card);
      });
    }

    function parseShopifyCSV(text){
      // Expect Shopify export columns: Title, Variant SKU, Image Src
      const lines = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(l=>l.trim());
      if(!lines.length) return [];
      const split = (row)=>{
        const out=[]; let cur='', q=false;
        for(let i=0;i<row.length;i++){
          const ch=row[i];
          if(ch=='"'){ if(q && row[i+1]=='"'){cur+='"'; i++;} else { q=!q; } }
          else if(ch==',' && !q){ out.push(cur); cur=''; }
          else cur+=ch;
        }
        out.push(cur); return out.map(x=>x.trim());
      };
      const headers = split(lines[0]); // keep case
      const idxTitle = headers.indexOf('Title');
      const idxSKU   = headers.indexOf('Variant SKU');
      const idxImg   = headers.indexOf('Image Src');
      const out=[];
      for(let i=1;i<lines.length;i++){
        const c = split(lines[i]);
        if(!c.length) continue;
        const name = idxTitle>-1 ? c[idxTitle] : '';
        const sku  = idxSKU>-1   ? c[idxSKU]   : '';
        const img  = idxImg>-1   ? c[idxImg]   : '';
        if(!(sku && img)) continue;
        out.push({sku, name, image: img});
      }
      return out;
    }

    function getQty(sku){ return CART[sku]?.qty||0; }
    function setQty(sku,q){
      if(q<=0) delete CART[sku];
      else { if(!CART[sku]){ const p = PRODUCTS.find(x=>x.sku===sku) || {sku}; CART[sku] = {sku: p.sku, name: p.name, image: p.image, qty: 0}; } CART[sku].qty=q; }
      renderCart(); renderGallery();
    }
    function add(p,n){ const q=(CART[p.sku]?.qty||0)+n; setQty(p.sku,q); }

    function renderCart(){
      cartEl.innerHTML='';
      const keys = Object.keys(CART);
      if(!keys.length){ cartEl.innerHTML='<div class="note">السلة فارغة.</div>'; return; }
      keys.forEach(k=>{
        const it=CART[k];
        const row=document.createElement('div'); row.className='rowitem';
        const img=document.createElement('img'); img.className='thumb'; img.src=it.image||''; img.alt=it.name||it.sku||'منتج';
        const meta=document.createElement('div'); meta.innerHTML = `<div style="font-weight:700">${it.name||it.sku}</div><div style="color:#6b7280;font-size:12px">SKU: ${it.sku}</div>`;
        const q=document.createElement('div'); q.textContent = 'x ' + it.qty;
        row.append(img, meta, q);
        cartEl.appendChild(row);
      });
    }

    function buildCSV(){
      const rows=[['SKU','Quantity']];
      Object.values(CART).forEach(it=>rows.push([it.sku, it.qty]));
      return rows.map(r=>r.map(v=>/[",\n]/.test(String(v)) ? '"' + String(v).replace(/"/g,'""') + '"' : v).join(',')).join('\n');
    }

    function fileName(){
      const from = (fromEl.value||'').trim().replace(/\s+/g,'-');
      const to   = (toEl.value||'').trim().replace(/\s+/g,'-');
      return (from && to) ? `transfer_${from}_to_${to}.csv` : 'transfer_.csv';
    }

    async function submitOrder(){
      if(!fromEl.value || !toEl.value){ alert('يجب اختيار الفرعين (من/إلى).'); return; }
      if(!Object.keys(CART).length){ alert('السلة فارغة.'); return; }
      const csv = buildCSV();
      const name = fileName();

      // تنزيل الملف
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);

      // إرسال إلى Zapier (no-cors لتجنب CORS محليًا)
      try{
        await fetch("https://hooks.zapier.com/hooks/catch/20490421/utyod6s/", {
          method:'POST',
          mode:'no-cors',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            file_name: name,
            from_branch: fromEl.value,
            to_branch: toEl.value,
            csv_text: csv,
            items: Object.values(CART)
          })
        });
        alert('تم إرسال الطلب (قد لا يظهر تأكيد من Zapier)، وتم تنزيل CSV.');
      }catch(e){
        alert('تم تنزيل CSV، لكن ربما تم حظر الإرسال إلى Zapier من المتصفح.');
      }
    }

    document.getElementById('submitOrder').onclick = submitOrder;

    // init
    renderCart(); renderGallery();
  </script>
</body>
</html>
